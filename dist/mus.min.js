!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.Mus=factory()}(this,function(){"use strict";function Mus(){void 0===this?console.error('Have you initialized Mus with "new" statement? (i.e. var mus = new Mus())'):(this.frames=[],this.timeouts=[],this.pos=0,this.currPos=0,this.startedAt=0,this.finishedAt=0,this.timePoint=!1,this.recordInputs=!0,this.recordCurrentElem=!1,this.curElemXPath=null,this.recording=!1,this.playing=!1,this.playbackSpeed=this.speed.NORMAL,this.observer="",this.window={width:window.outerWidth,height:window.outerHeight},this.onmousemove=window.onmousemove,this.onmousedown=window.onmousedown,this.onscroll=window.onscroll,this.inputWithUserKeyEvent=()=>{document.querySelectorAll("textarea, input[type=text], input[type=email], input[type=number], input[type=password], input[type=tel], input[type=search], input[type=url], input[type=search], input[type=week], input[type=month], input[type=datetime-local]").forEach(element=>{element.onkeydown=null})},this.inputWithOnchangeEvent=()=>{document.querySelectorAll("select, input[type=checkbox], input[type=radio], input[type=color], input[type=date], input[type=file], input[type=number], input[type=range], input[type=time]").forEach(element=>{element.onchange=null})})}return Mus.prototype={moveListener:function(callback){var self=this;return function(e){var record;callback&&(record=["m",e.clientX,e.clientY],self.recordCurrentElem&&(e=self.getXpathFromElement(e.target),record.push(self.curElemXPath===e?null:e),self.curElemXPath=e),callback(record))}},clickListener:function(callback){var self=this;return function(e){var record;callback&&(record=["c",e.clientX,e.clientY],self.recordCurrentElem&&(e=self.getXpathFromElement(e.target),record.push(self.curElemXPath===e?null:e),self.curElemXPath=e),callback(record))}},scrollListener:function(callback){return function(e){callback&&callback(["s",document.scrollingElement.scrollLeft,document.scrollingElement.scrollTop])}},inputWithUserKeyListener:function(callback){var self=this;return function(e){console.log(e),callback&&callback(["i",self.getXpathFromElement(e.target),e.target.value])}},inputWithOnchangeListener:function(callback){var self=this;return function(e){callback&&callback(["o",self.getXpathFromElement(e.target),e.target.value])}},mutationObserver:function(callback){return function(mutations){callback&&callback(mutations)}},record:function(onFrame){var self,targetNode,config,MutationObserver;this.recording||(0==(self=this).startedAt&&(self.startedAt=(new Date).getTime()/1e3),self.timePoint?self.frames.push(["s",document.scrollingElement.scrollLeft,document.scrollingElement.scrollTop,0]):self.frames.push(["s",document.scrollingElement.scrollLeft,document.scrollingElement.scrollTop]),self.recordInputs&&(document.querySelectorAll("textarea, input[type=text], input[type=email], input[type=number], input[type=password], input[type=tel], input[type=search], input[type=url], input[type=search], input[type=week], input[type=month], input[type=datetime-local]").forEach(element=>{self.timePoint?self.frames.push(["i",self.getXpathFromElement(element),element.value,0]):self.frames.push(["i",self.getXpathFromElement(element),element.value])}),document.querySelectorAll("select, input[type=checkbox], input[type=radio], input[type=color], input[type=date], input[type=file], input[type=number], input[type=range], input[type=time]").forEach(element=>{self.timePoint?"checkbox"==element.type||"radio"==element.type?self.frames.push(["o",self.getXpathFromElement(element),element.value,element.checked,0]):self.frames.push(["o",self.getXpathFromElement(element),element.value,0]):"checkbox"==element.type||"radio"==element.type?self.frames.push(["o",self.getXpathFromElement(element),element.value,element.checked]):self.frames.push(["o",self.getXpathFromElement(element),element.value])})),window.onmousemove=this.moveListener(function(pos){self.frames.push(self.timePoint?pos.concat((new Date).getTime()-1e3*self.startedAt):pos),onFrame instanceof Function&&onFrame()}),window.onmousedown=this.clickListener(function(click){self.frames.push(self.timePoint?click.concat((new Date).getTime()-1e3*self.startedAt):click),onFrame instanceof Function&&onFrame()}),window.onscroll=this.scrollListener(function(scroll){self.frames.push(self.timePoint?scroll.concat((new Date).getTime()-1e3*self.startedAt):scroll),onFrame instanceof Function&&onFrame()}),self.recordInputs&&(document.querySelectorAll("textarea, input[type=text], input[type=email], input[type=number], input[type=password], input[type=tel], input[type=search], input[type=url], input[type=search], input[type=week], input[type=month], input[type=datetime-local]").forEach(element=>{element.oninput=this.inputWithUserKeyListener(function(input){console.log(input),self.frames.push(self.timePoint?input.concat((new Date).getTime()-1e3*self.startedAt):input),onFrame instanceof Function&&onFrame()})}),document.querySelectorAll("select, input[type=checkbox], input[type=radio], input[type=color], input[type=date], input[type=file], input[type=number], input[type=range], input[type=time]").forEach(element=>{element.onchange=this.inputWithOnchangeListener(function(inputonchange){var element=self.getElementByXpath(inputonchange[1]);"checkbox"!=element.type&&"radio"!=element.type||(inputonchange=inputonchange.concat(element.checked)),self.frames.push(self.timePoint?inputonchange.concat((new Date).getTime()-1e3*self.startedAt):inputonchange),onFrame instanceof Function&&onFrame()})}),targetNode=document.querySelector("body"),config={attributes:!0,attributeOldValue:!0,subtree:!0},MutationObserver=window.MutationObserver||window.WebKitMutationObserver,this.observer=new MutationObserver(this.mutationObserver(function(mutations){for(var mutation of mutations){var mutationFrame;"attributes"==mutation.type&&(mutationFrame=[],mutationFrame=mutation.target.hasAttribute(mutation.attributeName)?["a",self.getXpathFromElement(mutation.target),mutation.attributeName,mutation.target.getAttribute(mutation.attributeName),mutation.oldValue,"M"]:["a",self.getXpathFromElement(mutation.target),mutation.attributeName,mutation.oldValue,"D"],self.frames.push(self.timePoint?mutationFrame.concat((new Date).getTime()-1e3*self.startedAt):mutationFrame),onFrame instanceof Function)&&onFrame()}})),this.observer.observe(targetNode,config)),self.recording=!0)},stop:function(){this.finishedAt=(new Date).getTime()/1e3,window.onmousemove=this.onmousemove,window.onmousedown=this.onmousedown,window.onscroll=this.onscroll,this.inputWithUserKeyEvent(),this.inputWithOnchangeEvent(),""!=this.observer&&this.observer.disconnect(),this.timeouts=[],this.recording=!1,this.playing=!1,this.pos=0},pause:function(){this.playing&&(this.pos=this.currPos,this.playing=!1,this.clearTimeouts())},play:function(onfinish){if(!this.playing){for(var self=this,node=(self.createCursor(),document.getElementById("musCursor")),delay="";self.pos<self.frames.length;self.pos++)delay=self.timePoint?self.frames[self.pos][self.frames[self.pos].length-1]:self.pos*self.playbackSpeed,self.timeouts.push(setTimeout(function(pos){self.playFrame(self,self.frames[pos],node),(self.currPos=pos)==self.frames.length-1&&(node.style.backgroundColor="transparent",self.timeouts=[],self.playing=!1,self.pos=0,onfinish)&&onfinish()},delay,self.pos));this.playing=!0}},release:function(){this.frames=[],this.startedAt=0,this.finishedAt=0,this.stop(),this.destroyCursor(),this.destroyClickSnapshot()},playFrame:function(self,frame,node){if("m"==frame[0])node.style.left=self.getXCoordinate(frame[1])+"px",node.style.top=self.getYCoordinate(frame[2])+"px";else if("c"==frame[0])self.createClickSnapshot(frame[2],frame[1]);else if("s"==frame[0])window.scrollTo(frame[1],frame[2]);else if("i"==frame[0])self.getElementByXpath(frame[1]).value=frame[2];else if("o"==frame[0]){let element=self.getElementByXpath(frame[1]);"checkbox"==element.type||"radio"==element.type?element.checked=frame[3]:element.value=frame[2]}else if("a"==frame[0]){let element=self.getElementByXpath(frame[1]);"M"==frame[5]?element.setAttribute(frame[2],frame[3]):"D"==frame[4]&&element.removeAttribute(frame[2])}},clearTimeouts:function(){for(var i in this.timeouts)clearTimeout(this.timeouts[i]);this.timeouts=[]},timeElapsed:function(){return this.finishedAt-this.startedAt},createCursor:function(){var node;document.getElementById("musCursor")||((node=document.createElement("div")).id="musCursor",node.style.position="fixed",node.style.width="32px",node.style.height="32px",node.style.top="-100%",node.style.left="-100%",node.style.borderRadius="32px",node.style.backgroundImage="url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiCSB2aWV3Qm94PSIwIDAgMjggMjgiIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI4IDI4IiB4bWw6c3BhY2U9InByZXNlcnZlIj48cG9seWdvbiBmaWxsPSIjRkZGRkZGIiBwb2ludHM9IjguMiwyMC45IDguMiw0LjkgMTkuOCwxNi41IDEzLDE2LjUgMTIuNiwxNi42ICIvPjxwb2x5Z29uIGZpbGw9IiNGRkZGRkYiIHBvaW50cz0iMTcuMywyMS42IDEzLjcsMjMuMSA5LDEyIDEyLjcsMTAuNSAiLz48cmVjdCB4PSIxMi41IiB5PSIxMy42IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjkyMjEgLTAuMzg3MSAwLjM4NzEgMC45MjIxIC01Ljc2MDUgNi41OTA5KSIgd2lkdGg9IjIiIGhlaWdodD0iOCIvPjxwb2x5Z29uIHBvaW50cz0iOS4yLDcuMyA5LjIsMTguNSAxMi4yLDE1LjYgMTIuNiwxNS41IDE3LjQsMTUuNSAiLz48L3N2Zz4=)",document.body.appendChild(node))},destroyCursor:function(){var cursor=document.getElementById("musCursor");cursor&&cursor.remove()},createClickSnapshot:function(x,y){var left=document.scrollingElement.scrollLeft,top=document.scrollingElement.scrollTop,node=document.createElement("div");node.className="musClickSnapshot",node.style.position="absolute",node.style.width="32px",node.style.height="32px",node.style.top=x+top+"px",node.style.left=y+left+"px",node.style.borderRadius="32px",node.style.backgroundColor="red",node.style.opacity=.2,document.body.appendChild(node)},destroyClickSnapshot:function(){for(var nodes=document.getElementsByClassName("musClickSnapshot");0<nodes.length;)nodes[0].remove()},getXCoordinate:function(x){return window.outerWidth>this.window.width?parseInt(this.window.width*x/window.outerWidth):parseInt(window.outerWidth*x/this.window.width)},getYCoordinate:function(y){return window.outerHeight>this.window.height?parseInt(this.window.height*y/window.outerHeight):parseInt(window.outerHeight*y/this.window.height)},getData:function(){return{frames:this.frames,timeElapsed:this.timeElapsed(),window:{width:window.outerWidth,height:window.outerHeight}}},isTimePoint:function(){return this.timePoint},setData:function(data){data.frames&&(this.frames=data.frames),data.window&&(this.window=data.window)},setFrames:function(frames){this.frames=frames},setWindowSize:function(width,height){this.window.width=width,this.window.height=height},setPlaybackSpeed:function(speed){this.playbackSpeed=speed},setTimePoint:function(timePoint){this.timePoint=timePoint},setRecordInputs:function(recordInputs){this.recordInputs=recordInputs},setRecordCurrentElem:function(recordCurrentElem){this.recordCurrentElem=recordCurrentElem},isRecording:function(){return this.recording},isPlaying:function(){return this.playing},speed:{SLOW:35,NORMAL:15,FAST:5},getXpathFromElement:function(elm){document.getElementsByTagName("*");for(var segs=[];elm&&1==elm.nodeType;elm=elm.parentNode){for(var i=1,sib=elm.previousSibling;sib;sib=sib.previousSibling)sib.localName==elm.localName&&i++;segs.unshift(elm.localName.toLowerCase()+"["+i+"]")}return segs.length?"/"+segs.join("/"):null},getElementByXpath:function(path){return(new XPathEvaluator).evaluate(path,document.documentElement,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}},Mus});